<?xml version="1.0" encoding="UTF-8"?>

<mule xmlns:bright-mart-experience-api="http://www.mulesoft.org/schema/mule/bright-mart-experience-api" xmlns:api-gateway="http://www.mulesoft.org/schema/mule/api-gateway" xmlns:bright-mart-process-api="http://www.mulesoft.org/schema/mule/bright-mart-process-api" xmlns="http://www.mulesoft.org/schema/mule/core" xmlns:apikit="http://www.mulesoft.org/schema/mule/mule-apikit" xmlns:doc="http://www.mulesoft.org/schema/mule/documentation" xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core" xmlns:http="http://www.mulesoft.org/schema/mule/http" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd http://www.mulesoft.org/schema/mule/http http://www.mulesoft.org/schema/mule/http/current/mule-http.xsd http://www.mulesoft.org/schema/mule/mule-apikit http://www.mulesoft.org/schema/mule/mule-apikit/current/mule-apikit.xsd http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd 
http://www.mulesoft.org/schema/mule/bright-mart-process-api http://www.mulesoft.org/schema/mule/bright-mart-process-api/current/mule-bright-mart-process-api.xsd
http://www.mulesoft.org/schema/mule/api-gateway http://www.mulesoft.org/schema/mule/api-gateway/current/mule-api-gateway.xsd
http://www.mulesoft.org/schema/mule/bright-mart-experience-api http://www.mulesoft.org/schema/mule/bright-mart-experience-api/current/mule-bright-mart-experience-api.xsd">

<http:listener-config name="experiencie-api-brightmart-httpListenerConfig">
        <http:listener-connection host="${http.host}" port="${http.port}" readTimeout="${http.timeout}"/>
    </http:listener-config>
    <apikit:config name="experiencie-api-brigthmart-config" api="resource::e8f87cdd-5727-4545-9258-3d76ee0ffa77:experiencie-api-brigthmart:1.0.1:raml:zip:experiencie-api-brigthmart.raml" outboundHeadersMapName="outboundHeaders" httpStatusVarName="httpStatus" /> 
	<configuration-properties doc:name="Configuration properties" doc:id="0bac4c21-92f2-4d7b-9a6f-80e80a861548" file="properties/${mule.env}-config.yaml" />
	<global-property doc:name="Global Property" doc:id="ac9d7ad1-a314-449c-896f-50c72ce79a18" name="mule.env" value="local" />
	<api-gateway:autodiscovery apiId="${api.id}" ignoreBasePath="true" doc:name="API Autodiscovery" doc:id="9e996f8f-8c0e-436d-812f-e64b651d039e" flowRef="experiencie-api-brigthmart-main" />
	<bright-mart-experience-api:config name="BrightMart_Experience_API_Config" doc:name="BrightMart Experience API Config" doc:id="90ddd346-e486-4d9e-9a7c-1fff263f8973" property_host="${process.host}" property_port="${process.port}" property_basePath="${process.basepath}" property_protocol="${process.protocol}" property_responseTimeout="${process.timeout}"/>
	<error-handler name="globalError_Handler" doc:id="26928f26-6ae9-4ad5-a5d7-baad32c9bb1c" >
		<on-error-propagate enableNotifications="true" logException="true" doc:name="On Error Propagate" doc:id="fab477f2-9e6d-4322-8a9e-eaf369ebbc65" >
			<set-variable value="#[%dw 2.0&#10;output application/java&#10;---&#10;if (sizeOf(error.suppressedErrors) &gt; 0)&#10;(error.suppressedErrors[0].errorMessage.attributes.statusCode as Number default 500)&#10;else (error.errorMessage.attributes.statusCode as Number default 500)]" doc:name="vars.httpStatus" doc:id="33bb8a70-ce8e-4c57-a336-9800b82bde8a" variableName="httpStatus"/>
			<ee:transform doc:name="Set Error Message" doc:id="db45e97f-a732-4953-8440-91ecbbdc5838" >
				<ee:message >
					<ee:set-payload ><![CDATA[%dw 2.0
output application/json
---
if (sizeOf(error.suppressedErrors) > 0)
	(error.suppressedErrors[0].errorMessage.payload as Object default
	{
		"code": vars.httpStatus as Number,
		"message": error.suppressedErrors[0].description default null,
		"x-correlation-id": correlationId,
		"timestamp": ((now() >> "UTC") as DateTime as String {format: "yyyy-MM-dd'T'HH:mm:ss'Z'"}),
		"details": error.suppressedErrors[0].detailedDescription default null
	}	
	)
else (error.errorMessage.payload as Object default
	{
		"code": vars.httpStatus as Number,
		"message": error.description default null,
		"x-correlation-id": correlationId,
		"timestamp": ((now() >> "UTC") as DateTime as String {format: "yyyy-MM-dd'T'HH:mm:ss'Z'"}),
		"details": error.detailedDescription default null
	}
)
 ]]></ee:set-payload>
				</ee:message>
			</ee:transform>
		</on-error-propagate>
	</error-handler>

</mule>
